<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <title>Controle Financeiro WebApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Tailwind CSS (ok para WebApp / desenvolvimento) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD -->
    <script
      src="https://unpkg.com/react@18/umd/react.production.min.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
      crossorigin
    ></script>
  </head>

  <body class="bg-slate-50 antialiased">
    <div id="root"></div>

    <script>
      const { useState, useEffect, useMemo } = React;

      // -------------------------------
      // Utilidades
      // -------------------------------
      function callServer(fnName, ...args) {
        return new Promise((resolve, reject) => {
          if (
            typeof google === "undefined" ||
            !google.script ||
            !google.script.run
          ) {
            reject(
              new Error(
                "google.script.run não está disponível (fora do Apps Script)."
              )
            );
            return;
          }

          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler((err) => {
              console.error("Erro Apps Script:", err);
              reject(err);
            })[fnName](...args);
        });
      }

      function getCurrentMonth() {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, "0");
        return year + "-" + month;
      }

      function formatCurrency(v) {
        const n = Number(v) || 0;
        return n.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      // -------------------------------
      // Tela inicial (landing)
      // -------------------------------
      function WelcomeScreen({ onEnter }) {
        return React.createElement(
          "div",
          { className: "min-h-screen flex items-center justify-center px-4" },
          React.createElement(
            "div",
            {
              className:
                "max-w-4xl w-full bg-white rounded-3xl shadow-xl overflow-hidden grid grid-cols-2",
            },
            // Lado esquerdo
            React.createElement(
              "div",
              { className: "p-8 md:p-10 flex flex-col justify-between" },
              React.createElement(
                "div",
                null,
                React.createElement(
                  "h1",
                  {
                    className:
                      "text-2xl md:text-3xl font-extrabold text-slate-900 mb-3",
                  },
                  "Controle Financeiro Simples"
                ),
                React.createElement(
                  "p",
                  { className: "text-sm text-slate-600 mb-6" },
                  "Organize suas finanças em um painel moderno, com todos os dados salvos em segurança na sua própria planilha Google."
                ),
                React.createElement(
                  "ul",
                  { className: "space-y-3 text-sm text-slate-700" },
                  React.createElement(
                    "li",
                    { className: "flex items-start gap-2" },
                    React.createElement(
                      "span",
                      {
                        className:
                          "mt-0.5 inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-600 text-xs",
                      },
                      "1"
                    ),
                    React.createElement(
                      "span",
                      null,
                      "Registre receitas e despesas de forma rápida e intuitiva."
                    )
                  ),
                  React.createElement(
                    "li",
                    { className: "flex items-start gap-2" },
                    React.createElement(
                      "span",
                      {
                        className:
                          "mt-0.5 inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-600 text-xs",
                      },
                      "2"
                    ),
                    React.createElement(
                      "span",
                      null,
                      "Visualize seus gastos com gráficos e indicadores claros."
                    )
                  ),
                  React.createElement(
                    "li",
                    { className: "flex items-start gap-2" },
                    React.createElement(
                      "span",
                      {
                        className:
                          "mt-0.5 inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-600 text-xs",
                      },
                      "3"
                    ),
                    React.createElement(
                      "span",
                      null,
                      "Seus dados ficam armazenados na planilha Google configurada para este WebApp."
                    )
                  )
                )
              ),
              React.createElement(
                "div",
                { className: "mt-6" },
                React.createElement(
                  "button",
                  {
                    type: "button",
                    onClick: onEnter,
                    className:
                      "w-full inline-flex justify-center items-center px-4 py-2.5 rounded-xl bg-blue-600 text-white text-sm font-semibold shadow hover:bg-blue-700 transition-colors",
                  },
                  "Acessar o painel"
                ),
                React.createElement(
                  "p",
                  {
                    className:
                      "mt-3 text-[11px] text-slate-400 text-center leading-snug",
                  },
                  "O acesso é feito com a sua conta Google. Seus dados não são compartilhados com terceiros."
                )
              )
            ),
            // Lado direito
            React.createElement(
              "div",
              {
                className:
                  "relative bg-gradient-to-br from-blue-600 via-blue-700 to-slate-900 text-white flex items-center justify-center p-6 md:p-8",
              },
              React.createElement(
                "div",
                {
                  className:
                    "absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_top,_rgba(255,255,255,0.4),_transparent_60%),_radial-gradient(circle_at_bottom,_rgba(59,130,246,0.6),_transparent_55%)]",
                }
              ),
              React.createElement(
                "div",
                { className: "relative z-10 text-center space-y-4" },
                React.createElement(
                  "div",
                  {
                    className:
                      "mx-auto w-14 h-14 rounded-2xl bg-white/10 border border-white/20 flex items-center justify-center",
                  },
                  React.createElement(
                    "span",
                    { className: "text-2xl" },
                    "✓"
                  )
                ),
                React.createElement(
                  "h2",
                  { className: "text-lg font-semibold" },
                  "Seguro e privado"
                ),
                React.createElement(
                  "p",
                  { className: "text-xs text-blue-100 leading-relaxed" },
                  "Os dados ficam restritos à planilha vinculada ao seu WebApp. Ideal para uso pessoal ou para compartilhar dentro de um time de confiança."
                )
              )
            )
          )
        );
      }

      // -------------------------------
      // Componentes do dashboard
      // -------------------------------
      function HeaderBar({ selectedMonth, onMonthChange, onRefresh, loading }) {
        return React.createElement(
          "header",
          { className: "bg-white shadow-sm sticky top-0 z-20" },
          React.createElement(
            "div",
            {
              className:
                "max-w-6xl mx-auto px-4 md:px-6 lg:px-8 py-3 flex flex-wrap items-center justify-between gap-3",
            },
            React.createElement(
              "div",
              { className: "flex items-center gap-2" },
              React.createElement("span", {
                className:
                  "w-2.5 h-2.5 rounded-full bg-blue-500 shadow shadow-blue-300",
              }),
              React.createElement(
                "h1",
                { className: "text-sm md:text-base font-semibold text-slate-800" },
                "Painel Financeiro"
              )
            ),
            React.createElement(
              "div",
              { className: "flex items-center gap-2 text-xs" },
              React.createElement(
                "span",
                { className: "text-slate-500" },
                "Mês de referência:"
              ),
              React.createElement("input", {
                type: "month",
                className:
                  "bg-slate-50 border border-slate-300 rounded-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                value: selectedMonth,
                onChange: (e) => onMonthChange(e.target.value),
              }),
              React.createElement(
                "button",
                {
                  type: "button",
                  onClick: onRefresh,
                  disabled: loading,
                  className:
                    "inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed",
                },
                loading
                  ? "Atualizando..."
                  : React.createElement(
                      React.Fragment,
                      null,
                      React.createElement(
                        "span",
                        { className: "hidden sm:inline" },
                        "Atualizar"
                      ),
                      React.createElement("span", null, "⟳")
                    )
              )
            )
          )
        );
      }

      function SummaryCards({ summary }) {
        if (!summary) return null;

        const cards = [
          {
            key: "receita",
            title: "Receita total",
            value: summary.receitaTotal,
            subtitle: "Soma das entradas do mês",
            icon: "⬆",
            iconColor:
              "bg-emerald-100 text-emerald-600 border border-emerald-200",
            type: "light",
          },
          {
            key: "paga",
            title: "Despesas pagas",
            value: summary.despesaPaga,
            subtitle: "Já saiu da conta",
            icon: "⬇",
            iconColor: "bg-rose-100 text-rose-600 border border-rose-200",
            type: "light",
          },
          {
            key: "pendente",
            title: "Despesas pendentes",
            value: summary.despesaPendente,
            subtitle: "Ainda vão sair",
            icon: "⏱",
            iconColor: "bg-amber-100 text-amber-600 border border-amber-200",
            type: "light",
          },
          {
            key: "saldo",
            title: "Saldo previsto / realizado",
            value: summary.saldoPrevisto,
            subtitle:
              formatCurrency(summary.saldoRealizado) +
              " realizado até agora",
            icon: "≡",
            iconColor:
              "bg-slate-800 text-slate-100 border border-slate-700",
            type: "dark",
          },
        ];

        return React.createElement(
          "div",
          {
            className:
              "grid grid-cols-4 gap-4 mb-4",
          },
          cards.map((card) => {
            const isDark = card.type === "dark";
            const containerClass = isDark
              ? "rounded-2xl bg-slate-900 text-slate-50 px-4 py-3 flex flex-col gap-1 shadow-md"
              : "rounded-2xl bg-white border border-slate-200 px-4 py-3 flex flex-col gap-1 shadow-sm";

            const titleClass = isDark
              ? "text-xs text-slate-200"
              : "text-xs text-slate-500";

            const valueClass = isDark
              ? "text-lg font-semibold text-white"
              : "text-lg font-semibold text-slate-900";

            const subtitleClass = isDark
              ? "text-[11px] text-slate-300"
              : "text-[11px] text-slate-500";

            return React.createElement(
              "div",
              { key: card.key, className: containerClass },
              React.createElement(
                "div",
                { className: "flex items-center justify-between gap-2" },
                React.createElement(
                  "div",
                  { className: titleClass },
                  card.title
                ),
                React.createElement(
                  "div",
                  {
                    className:
                      "inline-flex items-center justify-center w-6 h-6 rounded-full text-[11px] " +
                      card.iconColor,
                  },
                  card.icon
                )
              ),
              React.createElement(
                "div",
                { className: valueClass },
                formatCurrency(card.value || 0)
              ),
              React.createElement(
                "div",
                { className: subtitleClass },
                card.subtitle
              )
            );
          })
        );
      }

      function FiltersBar({ filters, onChange, categories }) {
        const handle = (field, value) => {
          onChange(Object.assign({}, filters, { [field]: value }));
        };

        const allCategories = useMemo(() => {
          const set = new Set([
            ...categories.receitas,
            ...categories.despesas,
          ]);
          return Array.from(set);
        }, [categories]);

        return React.createElement(
          "div",
          {
            className:
              "bg-white border border-slate-200 rounded-2xl px-4 py-3 mb-4 shadow-sm",
          },
          React.createElement(
            "div",
            { className: "grid grid-cols-5 gap-3 text-xs" },
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Tipo"
              ),
              React.createElement(
                "select",
                {
                  className:
                    "border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                  value: filters.tipo,
                  onChange: (e) => handle("tipo", e.target.value),
                },
                React.createElement("option", { value: "TODOS" }, "Todos"),
                React.createElement("option", { value: "RECEITA" }, "Receitas"),
                React.createElement("option", { value: "DESPESA" }, "Despesas")
              )
            ),
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Categoria"
              ),
              React.createElement(
                "select",
                {
                  className:
                    "border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                  value: filters.categoria,
                  onChange: (e) => handle("categoria", e.target.value),
                },
                React.createElement("option", { value: "" }, "Todas"),
                allCategories.map((cat) =>
                  React.createElement(
                    "option",
                    { key: cat, value: cat },
                    cat
                  )
                )
              )
            ),
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Status"
              ),
              React.createElement(
                "select",
                {
                  className:
                    "border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                  value: filters.status,
                  onChange: (e) => handle("status", e.target.value),
                },
                React.createElement("option", { value: "" }, "Todos"),
                React.createElement("option", { value: "PAGO" }, "Pago"),
                React.createElement("option", { value: "PENDENTE" }, "Pendente")
              )
            ),
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Valor mín."
              ),
              React.createElement("input", {
                type: "number",
                className:
                  "border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                value: filters.minValor,
                onChange: (e) => handle("minValor", e.target.value),
              })
            ),
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Valor máx. / Busca"
              ),
              React.createElement(
                "div",
                { className: "flex gap-2" },
                React.createElement("input", {
                  type: "number",
                  placeholder: "Máx.",
                  className:
                    "w-20 border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                  value: filters.maxValor,
                  onChange: (e) => handle("maxValor", e.target.value),
                }),
                React.createElement("input", {
                  type: "text",
                  placeholder: "Descrição ou categoria",
                  className:
                    "flex-1 border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                  value: filters.busca,
                  onChange: (e) => handle("busca", e.target.value),
                })
              )
            )
          )
        );
      }

      // Pequeno "gráfico de rosca" em SVG (sem Recharts)
      function DonutChart({ receita, despesas }) {
        const total = receita + despesas;
        if (!total) {
          return React.createElement(
            "div",
            { className: "text-[11px] text-slate-500 mt-4" },
            "Ainda não há dados suficientes para exibir o gráfico."
          );
        }

        const radius = 38;
        const circumference = 2 * Math.PI * radius;
        const percDespesas = despesas / total;
        const despesasStroke = circumference * percDespesas;
        const receitaStroke = circumference - despesasStroke;

        return React.createElement(
          "div",
          { className: "flex items-center gap-4 mt-4" },
          React.createElement(
            "svg",
            { width: 96, height: 96, viewBox: "0 0 96 96" },
            React.createElement("circle", {
              cx: 48,
              cy: 48,
              r: radius,
              fill: "none",
              stroke: "#e5e7eb",
              "stroke-width": 10,
            }),
            React.createElement("circle", {
              cx: 48,
              cy: 48,
              r: radius,
              fill: "none",
              stroke: "#ef4444",
              "stroke-width": 10,
              "stroke-dasharray": despesasStroke + " " + circumference,
              "stroke-dashoffset": circumference * -0.25,
              "stroke-linecap": "round",
            }),
            React.createElement("circle", {
              cx: 48,
              cy: 48,
              r: radius,
              fill: "none",
              stroke: "#22c55e",
              "stroke-width": 10,
              "stroke-dasharray": receitaStroke + " " + circumference,
              "stroke-dashoffset": circumference * -0.25 + despesasStroke,
              "stroke-linecap": "round",
            })
          ),
          React.createElement(
            "div",
            { className: "text-[11px] space-y-1 text-slate-600" },
            React.createElement(
              "div",
              { className: "flex items-center gap-2" },
              React.createElement("span", {
                className: "w-3 h-3 rounded-full bg-emerald-500",
              }),
              React.createElement(
                "span",
                null,
                "Receitas: ",
                formatCurrency(receita)
              )
            ),
            React.createElement(
              "div",
              { className: "flex items-center gap-2" },
              React.createElement("span", {
                className: "w-3 h-3 rounded-full bg-rose-500",
              }),
              React.createElement(
                "span",
                null,
                "Despesas: ",
                formatCurrency(despesas)
              )
            ),
            React.createElement(
              "div",
              { className: "mt-2 text-[10px] text-slate-500" },
              "O círculo representa a proporção entre receitas (verde) e despesas (vermelho) no mês."
            )
          )
        );
      }

      function TransactionForm({
        month,
        categorias,
        onSubmit,
        saving,
        editingTx,
        onCancelEdit,
      }) {
        const [form, setForm] = useState(null);

        useEffect(() => {
          if (editingTx) {
            setForm({
              data: editingTx.data,
              tipo: editingTx.tipo,
              categoria: editingTx.categoria,
              descricao: editingTx.descricao,
              valor: editingTx.valor,
              status: editingTx.status,
            });
          } else {
            const today = new Date();
            const [y, m] = month.split("-");
            let defaultDate = month + "-01";
            if (
              Number(y) === today.getFullYear() &&
              Number(m) === today.getMonth() + 1
            ) {
              defaultDate = today.toISOString().split("T")[0];
            }
            setForm({
              data: defaultDate,
              tipo: "DESPESA",
              categoria: "",
              descricao: "",
              valor: "",
              status: "PAGO",
            });
          }
        }, [editingTx, month]);

        if (!form) return null;

        const handleChange = (field, value) => {
          setForm(Object.assign({}, form, { [field]: value }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          if (
            !form.data ||
            !form.tipo ||
            !form.categoria ||
            !form.valor ||
            !form.status
          ) {
            alert("Preencha os campos obrigatórios.");
            return;
          }
          onSubmit(form, editingTx ? editingTx.id : null);
        };

        const categoriasPorTipo =
          form.tipo === "RECEITA"
            ? categorias.receitas
            : categorias.despesas;

        return React.createElement(
          "form",
          {
            onSubmit: handleSubmit,
            className:
              "bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-3",
          },
          React.createElement(
            "div",
            { className: "flex items-center justify-between" },
            React.createElement(
              "h2",
              { className: "text-sm font-semibold text-slate-800" },
              editingTx ? "Editar transação" : "Nova transação"
            ),
            editingTx &&
              React.createElement(
                "button",
                {
                  type: "button",
                  onClick: onCancelEdit,
                  className:
                    "text-[11px] text-slate-500 hover:text-slate-700 underline",
                },
                "Cancelar edição"
              )
          ),
          React.createElement(
            "div",
            { className: "grid grid-cols-2 gap-3 text-xs" },
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Data"
              ),
              React.createElement("input", {
                type: "date",
                className:
                  "border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                value: form.data,
                onChange: (e) => handleChange("data", e.target.value),
              })
            ),
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Tipo"
              ),
              React.createElement(
                "select",
                {
                  className:
                    "border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                  value: form.tipo,
                  onChange: (e) => handleChange("tipo", e.target.value),
                },
                React.createElement("option", { value: "DESPESA" }, "Despesa"),
                React.createElement("option", { value: "RECEITA" }, "Receita")
              )
            )
          ),
          React.createElement(
            "div",
            { className: "grid grid-cols-2 gap-3 text-xs" },
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Categoria"
              ),
              React.createElement(
                "select",
                {
                  className:
                    "border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                  value: form.categoria,
                  onChange: (e) => handleChange("categoria", e.target.value),
                },
                React.createElement("option", { value: "" }, "Selecione"),
                categoriasPorTipo.map((c) =>
                  React.createElement("option", { key: c, value: c }, c)
                ),
                React.createElement("option", { value: "Outros" }, "Outros")
              )
            ),
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Status"
              ),
              React.createElement(
                "select",
                {
                  className:
                    "border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                  value: form.status,
                  onChange: (e) => handleChange("status", e.target.value),
                },
                React.createElement("option", { value: "PAGO" }, "Pago"),
                React.createElement("option", { value: "PENDENTE" }, "Pendente")
              )
            )
          ),
          React.createElement(
            "div",
            { className: "grid grid-cols-2 gap-3 text-xs" },
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Descrição"
              ),
              React.createElement("input", {
                type: "text",
                className:
                  "border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                value: form.descricao,
                onChange: (e) => handleChange("descricao", e.target.value),
              })
            ),
            React.createElement(
              "div",
              { className: "flex flex-col gap-1" },
              React.createElement(
                "label",
                { className: "text-slate-600" },
                "Valor (R$)"
              ),
              React.createElement("input", {
                type: "number",
                step: "0.01",
                min: "0.01",
                className:
                  "border border-slate-300 rounded-lg px-2 py-1 bg-slate-50",
                value: form.valor,
                onChange: (e) => handleChange("valor", e.target.value),
              })
            )
          ),
          React.createElement(
            "div",
            { className: "pt-1 flex justify-end" },
            React.createElement(
              "button",
              {
                type: "submit",
                disabled: saving,
                className:
                  "inline-flex items-center justify-center px-4 py-2 rounded-xl bg-orange-500 text-white text-xs font-semibold hover:bg-orange-600 disabled:opacity-60 disabled:cursor-not-allowed",
              },
              saving
                ? "Salvando..."
                : editingTx
                ? "Salvar alterações"
                : "Salvar transação"
            )
          )
        );
      }

      function TransactionsTable({ transactions, onEdit, onDelete, loading }) {
        if (loading) {
          return React.createElement(
            "div",
            {
              className:
                "bg-white rounded-2xl border border-slate-200 shadow-sm p-4",
            },
            React.createElement(
              "p",
              { className: "text-xs text-slate-500" },
              "Carregando transações..."
            )
          );
        }

        if (!transactions.length) {
          return React.createElement(
            "div",
            {
              className:
                "bg-white rounded-2xl border border-slate-200 shadow-sm p-4",
            },
            React.createElement(
              "p",
              { className: "text-xs text-slate-500" },
              "Nenhuma transação encontrada para os filtros selecionados."
            )
          );
        }

        return React.createElement(
          "div",
          {
            className:
              "bg-white rounded-2xl border border-slate-200 shadow-sm p-4 overflow-auto",
          },
          React.createElement(
            "table",
            { className: "min-w-full text-xs" },
            React.createElement(
              "thead",
              null,
              React.createElement(
                "tr",
                { className: "text-[11px] text-slate-500 border-b" },
                React.createElement(
                  "th",
                  { className: "py-2 px-2 text-left" },
                  "Data / Categoria"
                ),
                React.createElement(
                  "th",
                  { className: "py-2 px-2 text-left" },
                  "Descrição"
                ),
                React.createElement(
                  "th",
                  { className: "py-2 px-2 text-right" },
                  "Valor"
                ),
                React.createElement(
                  "th",
                  { className: "py-2 px-2 text-right" },
                  "Status"
                ),
                React.createElement(
                  "th",
                  { className: "py-2 px-2 text-right" },
                  "Ações"
                )
              )
            ),
            React.createElement(
              "tbody",
              null,
              transactions.map((tx) => {
                const tipoClass =
                  tx.tipo === "RECEITA"
                    ? "bg-emerald-50 text-emerald-700"
                    : "bg-rose-50 text-rose-700";
                const statusClass =
                  tx.status === "PAGO"
                    ? "text-emerald-600"
                    : "text-amber-600";
                return React.createElement(
                  "tr",
                  {
                    key: tx.id,
                    className:
                      "border-b border-slate-100 last:border-b-0 hover:bg-slate-50",
                  },
                  React.createElement(
                    "td",
                    { className: "py-2 px-2 align-top" },
                    React.createElement(
                      "div",
                      { className: "text-xs text-slate-800" },
                      tx.data
                    ),
                    React.createElement(
                      "div",
                      { className: "text-[11px] text-slate-500" },
                      tx.categoria
                    )
                  ),
                  React.createElement(
                    "td",
                    { className: "py-2 px-2 align-top text-xs text-slate-700" },
                    tx.descricao
                  ),
                  React.createElement(
                    "td",
                    {
                      className:
                        "py-2 px-2 align-top text-xs text-right text-slate-800",
                    },
                    React.createElement(
                      "span",
                      {
                        className:
                          "inline-flex px-2 py-0.5 rounded-full " + tipoClass,
                      },
                      formatCurrency(tx.valor)
                    )
                  ),
                  React.createElement(
                    "td",
                    {
                      className:
                        "py-2 px-2 align-top text-xs text-right " + statusClass,
                    },
                    tx.status
                  ),
                  React.createElement(
                    "td",
                    {
                      className:
                        "py-2 px-2 align-top text-[11px] text-right space-x-3",
                    },
                    React.createElement(
                      "button",
                      {
                        type: "button",
                        className:
                          "text-blue-600 hover:text-blue-800 underline",
                        onClick: () => onEdit(tx),
                      },
                      "Editar"
                    ),
                    React.createElement(
                      "button",
                      {
                        type: "button",
                        className:
                          "text-rose-500 hover:text-rose-700 underline",
                        onClick: () => onDelete(tx),
                      },
                      "Excluir"
                    )
                  )
                );
              })
            )
          )
        );
      }

      // -------------------------------
      // App principal
      // -------------------------------
      function DashboardApp() {
        const [view, setView] = useState("welcome"); // welcome | dashboard
        const [selectedMonth, setSelectedMonth] = useState(getCurrentMonth());
        const [transactions, setTransactions] = useState([]);
        const [summary, setSummary] = useState(null);
        const [categories, setCategories] = useState({
          receitas: [],
          despesas: [],
        });
        const [filters, setFilters] = useState({
          tipo: "TODOS",
          categoria: "",
          status: "",
          minValor: "",
          maxValor: "",
          busca: "",
        });
        const [loading, setLoading] = useState(false);
        const [saving, setSaving] = useState(false);
        const [editingTx, setEditingTx] = useState(null);
        const [error, setError] = useState("");

        const loadAll = (month) => {
          setLoading(true);
          setError("");
          Promise.all([
            callServer("getTransactionsByMonth", month),
            callServer("getMonthlySummary", month),
            callServer("getCategories"),
          ])
            .then(([txResp, sumResp, catsResp]) => {
              if (!txResp.success)
                throw new Error(
                  txResp.error || "Erro ao carregar transações."
                );
              if (!sumResp.success)
                throw new Error(
                  sumResp.error || "Erro ao calcular o resumo."
                );
              if (!catsResp.success)
                throw new Error(
                  catsResp.error || "Erro ao carregar categorias."
                );

              setTransactions(txResp.data || []);
              setSummary(sumResp.resumo || null);
              setCategories({
                receitas: catsResp.receitas || [],
                despesas: catsResp.despesas || [],
              });
            })
            .catch((err) => {
              console.error(err);
              setError(err.message || "Erro ao buscar dados.");
            })
            .finally(() => setLoading(false));
        };

        useEffect(() => {
          if (view === "dashboard") {
            loadAll(selectedMonth);
          }
        }, [view, selectedMonth]);

        const handleSave = (form, editingId) => {
          setSaving(true);
          setError("");
          const payload = {
            data: form.data,
            tipo: form.tipo,
            categoria: form.categoria,
            descricao: form.descricao,
            valor: Number(form.valor || 0),
            status: form.status,
            mesRef: selectedMonth,
          };
          let promise;
          if (editingId) {
            payload.id = editingId;
            promise = callServer("updateTransaction", payload);
          } else {
            promise = callServer("saveTransaction", payload);
          }

          promise
            .then((resp) => {
              if (!resp || !resp.success) {
                throw new Error(
                  (resp && resp.error) || "Erro ao salvar transação."
                );
              }
              setEditingTx(null);
              loadAll(selectedMonth);
            })
            .catch((err) => {
              console.error(err);
              setError(err.message || "Erro ao salvar transação.");
            })
            .finally(() => setSaving(false));
        };

        const handleDelete = (tx) => {
          if (!tx || !tx.id) return;
          if (!window.confirm("Excluir a transação selecionada?")) return;
          setSaving(true);
          setError("");
          callServer("deleteTransaction", tx.id)
            .then((resp) => {
              if (!resp || !resp.success) {
                throw new Error(
                  (resp && resp.error) || "Erro ao excluir transação."
                );
              }
              if (editingTx && editingTx.id === tx.id) {
                setEditingTx(null);
              }
              loadAll(selectedMonth);
            })
            .catch((err) => {
              console.error(err);
              setError(err.message || "Erro ao excluir transação.");
            })
            .finally(() => setSaving(false));
        };

        const filteredTransactions = useMemo(() => {
          return transactions.filter((tx) => {
            if (filters.tipo === "RECEITA" && tx.tipo !== "RECEITA")
              return false;
            if (filters.tipo === "DESPESA" && tx.tipo !== "DESPESA")
              return false;
            if (filters.categoria && tx.categoria !== filters.categoria)
              return false;
            if (filters.status && tx.status !== filters.status) return false;

            const v = Number(tx.valor || 0);
            if (filters.minValor && v < Number(filters.minValor)) return false;
            if (filters.maxValor && v > Number(filters.maxValor)) return false;

            if (filters.busca) {
              const term = String(filters.busca).toLowerCase();
              const texto =
                String(tx.descricao || "").toLowerCase() +
                " " +
                String(tx.categoria || "").toLowerCase();
              if (!texto.includes(term)) return false;
            }

            return true;
          });
        }, [transactions, filters]);

        const despesasTotais = useMemo(() => {
          return (summary ? summary.despesaPaga : 0) +
            (summary ? summary.despesaPendente : 0);
        }, [summary]);

        // Troca da tela inicial para o painel
        if (view === "welcome") {
          return React.createElement(WelcomeScreen, {
            onEnter: () => setView("dashboard"),
          });
        }

        return React.createElement(
          "div",
          { className: "min-h-screen bg-slate-50" },
          React.createElement(HeaderBar, {
            selectedMonth,
            onMonthChange: (m) => setSelectedMonth(m),
            onRefresh: () => loadAll(selectedMonth),
            loading,
          }),
          React.createElement(
            "main",
            {
              className:
                "max-w-6xl mx-auto px-4 md:px-6 lg:px-8 py-4 space-y-4",
            },
            error &&
              React.createElement(
                "div",
                  {
                    className:
                      "bg-rose-50 border border-rose-200 text-rose-700 text-xs rounded-xl px-3 py-2",
                  },
                  error
              ),
            React.createElement(SummaryCards, { summary }),
            React.createElement(FiltersBar, {
              filters,
              onChange: setFilters,
              categories,
            }),
            React.createElement(
              "div",
              {
                className:
                  "grid grid-cols-[2fr,1fr] gap-4 items-start",
              },
              React.createElement(TransactionsTable, {
                transactions: filteredTransactions,
                onEdit: (tx) => {
                  setEditingTx(tx);
                  const el = document.getElementById("form-anchor");
                  if (el) {
                    el.scrollIntoView({
                      behavior: "smooth",
                      block: "start",
                    });
                  }
                },
                onDelete: handleDelete,
                loading,
              }),
              React.createElement(
                "div",
                { id: "form-anchor", className: "space-y-4" },
                React.createElement(TransactionForm, {
                  month: selectedMonth,
                  categorias: categories,
                  onSubmit: handleSave,
                  saving,
                  editingTx,
                  onCancelEdit: () => setEditingTx(null),
                }),
                React.createElement(
                  "div",
                  {
                    className:
                      "bg-white rounded-2xl border border-slate-200 shadow-sm p-4 text-xs",
                  },
                  React.createElement(
                    "h2",
                    { className: "text-sm font-semibold text-slate-800" },
                    "Receitas vs. Despesas"
                  ),
                  React.createElement(DonutChart, {
                    receita: summary ? summary.receitaTotal : 0,
                    despesas: despesasTotais,
                  })
                )
              )
            ),
            React.createElement(
              "p",
              {
                className:
                  "mt-6 text-[10px] text-slate-400 text-center leading-snug",
              },
              "Os dados exibidos neste painel são lidos e gravados diretamente na planilha Google configurada no WebApp."
            )
          )
        );
      }

      document.addEventListener("DOMContentLoaded", () => {
        const rootEl = document.getElementById("root");
        if (!rootEl) return;
        const root = ReactDOM.createRoot(rootEl);
        root.render(React.createElement(DashboardApp));
      });
    </script>
  </body>
</html>
